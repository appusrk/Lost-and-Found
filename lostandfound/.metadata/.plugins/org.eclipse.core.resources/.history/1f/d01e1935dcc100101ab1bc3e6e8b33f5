package com.example.lostandfound.controller;

import com.example.lostandfound.model.Issues;
import com.example.lostandfound.model.Users;
import com.example.lostandfound.repository.IssueRepository;
import com.example.lostandfound.repository.UserRepository;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/issues")
public class IssueController {

    private final IssueRepository issuesRepository;
    private final UserRepository userRepository;

    public IssueController(IssueRepository issuesRepository, UserRepository userRepository) {
        this.issuesRepository = issuesRepository;
        this.userRepository = userRepository;
    }

    // 1️⃣ Get all issues
    @GetMapping
    public List<Issues> getAllIssues() {
        return issuesRepository.findAll();
    }

    // 2️⃣ Add issue (with USN coming from request)
    @PostMapping
    public Issues addIssue(@RequestBody Issues issue) {

        String usn = issue.getUser().getUsn();   // Extract USN from the JSON
        Users user = userRepository.findByUsn(usn);

        if (user == null) {
            throw new RuntimeException("User not found: " + usn);
        }

        issue.setUser(user);    // Attach actual user entity
        return issuesRepository.save(issue);
    }

    // 3️⃣ Get issues by user
    @GetMapping("/user/{usn}")
    public List<Issues> getIssuesByUser(@PathVariable String usn) {
        return issuesRepository.findByUser_Usn(usn);
    }

    // 4️⃣ Delete issue
    @DeleteMapping("/{id}")
    public void deleteIssue(@PathVariable int id) {
        issuesRepository.deleteById(id);
    }
}
