package com.example.lostandfound.controller;

import com.example.lostandfound.model.*;
import org.springframework.web.multipart.MultipartFile;
import com.example.lostandfound.repository.FoundItemRepository;
import com.example.lostandfound.repository.LostItemRepository;
import com.example.lostandfound.services.MatchingServices;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.Optional;

@RestController
@RequestMapping("/api/lost")
public class LostItemController {

    private final LostItemRepository lostItemRepository;
    private final MatchingServices matchingServices; 
    private final RestTemplate restTemplate = new RestTemplate(); // To call Python AI

    public LostItemController(LostItemRepository lostItemRepository,
                              MatchingServices matchingServices) {
        this.lostItemRepository = lostItemRepository;
        this.matchingServices = matchingServices;
    }

    @PostMapping(consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
    public Lost_items addLostItem(
            @RequestParam("itemName") String itemName,
            @RequestParam("description") String description,
            @RequestParam("location") String location,
            @RequestParam("contact") String contact,
            @RequestParam(value = "image", required = false) MultipartFile image
    ) throws IOException, NoSuchAlgorithmException {

        Lost_items lostItem = new Lost_items();
        lostItem.setItemName(itemName);
        lostItem.setDescription(description);
        lostItem.setLocation(location);
        lostItem.setContact(contact);

        if (image != null && !image.isEmpty()) {
            String fileName = UUID.randomUUID() + "_" + image.getOriginalFilename();
            Path filePath = Paths.get("uploads/" + fileName);
            Files.createDirectories(filePath.getParent());
            Files.write(filePath, image.getBytes());

            // Compute SHA-256 hash
            MessageDigest digest = MessageDigest.getInstance("SHA-256");
            byte[] hashBytes = digest.digest(image.getBytes());
            StringBuilder sb = new StringBuilder();
            for (byte b : hashBytes) sb.append(String.format("%02x", b));

            lostItem.setImageUrl("/uploads/" + fileName);
            lostItem.setImageHash(sb.toString());
        }

        Lost_items saved = lostItemRepository.save(lostItem);

        // Call Python AI service for matching
        Map<String, Object> payload = new HashMap<>();
        payload.put("itemName", saved.getItemName());
        payload.put("description", saved.getDescription());
        payload.put("imageUrl", saved.getImageUrl());

        ResponseEntity<List> response = restTemplate.postForEntity(
            "http://localhost:5000/match", payload, List.class
        );

        // Python returns list of found items
        List<?> matches = response.getBody();

        System.out.println("Matches from AI: " + matches);

        return saved;
    }
}

}
